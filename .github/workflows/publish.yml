name: Publish

on:
  push:
    branches:
      - dev
    tags:
      - 'v*.*.*'
    paths-ignore:
      - '**/*.md'
      - LICENSE
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

env:
  CI: true
  NPM_CONFIG_FUND: 'false'
  PNPM_HOME: ~/.pnpm

jobs:
  publish-release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Verify npm package
        run: npm pack --dry-run

      - name: Verify tag matches package version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION="$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).version)")"
          test "$TAG_VERSION" = "$PKG_VERSION"

      - name: Publish to npm (latest)
        run: npm publish --provenance

  publish-dev:
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Set unique dev version
        id: version
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const outputPath = process.env.GITHUB_OUTPUT;
          const runNumber = process.env.GITHUB_RUN_NUMBER;
          const runAttempt = process.env.GITHUB_RUN_ATTEMPT;
          const pkgPath = 'package.json';
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));

          const match = String(pkg.version).match(/^(\d+\.\d+\.\d+)(?:[-+].*)?$/);
          if (!match) {
            throw new Error('package.json version must be semver x.y.z[/pre]');
          }

          const devVersion = `${match[1]}-dev.${runNumber}.${runAttempt}`;
          pkg.version = devVersion;
          fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');
          fs.appendFileSync(outputPath, `dev_version=${devVersion}\n`);
          console.log(`Using dev version: ${devVersion}`);
          NODE

      - name: Verify npm package
        run: npm pack --dry-run

      - name: Publish to npm (dev tag)
        run: npm publish --tag dev --provenance
